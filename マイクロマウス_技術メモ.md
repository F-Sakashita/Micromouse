# 目的

- マイクロマウスを設計する際の備忘録をここに残す．技術範囲はマイクロマウス 限定でも良い．わかったこと，疑問に思っていること，何でもいいのでメモする．記入ルールとしてはカテゴリ別に分けるだけで，あとは自由．参考にしたURLや書籍の情報，なぜその設計にしたのかは必ずメモすること．



## マウス用語

- マウス本：苦しんで作るマイクロマウス 





# 回路

### Kicad

- 回路ごとで階層シートを分けると見やすい．
  - MCUの回路の下層に電源，モータ駆動，壁センサのシートを作成し，それぞれに階層ラベルを追加した．

## 回路設計

###  回路部品

#### チップ抵抗

-  チップサイズが大きくなるにつれて最大電力が増えていく．1608サイズだと1/10W．定格電力の1/2以下の消費電力で使用する．[抵抗器の基礎知識：ROHM株式会社](https://www.rohm.co.jp/electronics-basics/resistors/r_what1)

#### チップコンデンサ

- セラミックコンデンサの場合，チップサイズが大きくなるにつれて耐圧が増える．一般的に耐圧と容量はトレードオフの関係．耐圧が増える→容量が小さい
  - 村田のラインナップがわかりやすい．選定の参考になる．[一般用チップ積層セラミックコンデンサ：村田製作所](https://www.murata.com/ja-jp/products/capacitor/ceramiccapacitor/smd/grm)

### 駆動回路

- Faulhaber1717T003SRの定格時の起動電流は2.712 A (= 起動トルク/トルク定数より算出)，連続電流0.7A
  - トルク定数：1.98 mNm/A,  起動トルク：5.47 mNm
- MDはモータの起動電流，連続電流を超えるように，TB6612FNGを採用（平均1.2A, ピーク3.2A)
- ただ定格電圧3Vに対して，MDの電源電圧が最大8.4Vと定格の2倍以上・・・出力制限するのかな・・・？定格6Vのモータに変更にするべき？
  - 6Vの場合，起動電流1.35A, 連続0.63A．定常時のトルクは3Vより大きいが回転数が劣る．逆起電圧も大きい．3Vよりちょい高価．[2019年のテクニカルデータ集](http://www.ntf.or.jp/mouse/micromouse2019/result/mm2019recode_v104.pdf)には両方いる・・・まじで定格2倍以上で使用してるのか？
    - まじだった（3Vに3セルとか突っ込んでる・・・）[マウサーの方のTwitter](https://twitter.com/tennisyi/status/802868693659099137)

### 発光回路

- マウス本をほぼ真似た．オペアンプ の入力信号の分圧回路を3.3Vに合わせた．電流量の計算は回路図に記載．

### 受光回路

- フォトトランジスタの負荷抵抗を1k にしたが，なぜ1kという値が良いのか，マイコンからはこの信号がどう見えるのかが不明．下記の参考ページと同じ回路を採用．実機で動作確認する．
  - 負荷抵抗を1kにした時のAD値の算出について調べること
  - 参考：https://rt-net.jp/mobility/archives/14559

## 基板設計

### パターン幅, ビア径

- 1mm = 1A,   

### 電源回路

- パターン幅はなるべく太く．ベタでやったほうが良さげ？
  - 例えば[このマウサーの方のブログ](https://nout.hatenadiary.jp/entry/2018/05/17/161537)にあるAWを見ると，モータ電源のVCCはかなり太いベタ配線．
  - モータ1つで連続1.0Aなため，最低で4Aくらいは流せるくらいパターン幅(4mmくらい)を確保したほうが良い？

### 駆動回路

- パターン幅はモータの連続電流量を超える太さにする．連続1.0Aくらいになるだろう

### 回路Version

#### V1.0 

- 2020/12に発注
- 電源スイッチ回路のバグを発見
- 5V->3.3Vのレギュレータの選定を誤っていた．購入したレギュレータとのピン配置が異なっており，電源投入後ショートの状態になっている
- 電源スイッチのON方向を表すシルクが，選定したスイッチのものと方向が逆

#### V1.1

- 2021/1に発注
- 電源回路周辺を修正．シルクを修正
- Lチカできることを確認
- シルクが一部反映されていなかった．
- USB-Serial変換モジュールを指す向きが反対になるようなピン配置だった
  - 縦向きに指す予定なのでこのままでOK
- リセットボタン・モードボタンが押しにくい．LEDの位置が指に被り見えにくい
- スイッチの向きを逆にしたい（機体内側に倒すとON状態）
- STLINKが差しにくい．コネクタを選定するか，NucleoのSTLinkをそのまま挿せるようにするとか
- ブザーのピンがPWM使えない
- 壁センサの固定パーツがあった方が良い．指向性がぶれる
- 



# ソフト

## 組込

### SPI

- SDI : SPI serial data input = MISO
- SDO : SPI serial data output = MOSI
- SPI mode 0 :
  - CPOL=0 : アイドル状態のCLKがLow
  - CPHA=0 :  データを立ち上がりでサンプリング（Read），立ち下がりでシフト（Write）
- SPI mode 1 : 
  - CPOL=0 : アイドル状態のCLKがLow
  - CPHA=1 :  データを立ち下がりでサンプリング（Read），立ち上がりでシフト（Write）
- SPI mode 2 :
  - CPOL=1 : アイドル状態のCLKがHigh
  - CPHA=0 :  データを立ち上がりでサンプリング（Read），立ち下がりでシフト（Write）
- SPI mode 3 : 
  - CPOL=1 : アイドル状態のCLKがHigh
  - CPHA=1 :  データを立ち下がりでサンプリング（Read），立ち上がりでシフト（Write）

[SPI通信:AnalogDevices](https://www.analog.com/jp/analog-dialogue/articles/introduction-to-spi-interface.html#)

### ICM-20602

- SPIは最大10MHz, MSB first
- SPI modeは
  - CLKがアイドル時High

### STM32

#### printf

https://garberas.com/archives/99

#### CMSIS



## 姿勢推定(IMU)

### そもそも論

- ヨー角は3軸加速度センサだけでは推定できない（姿勢を推定する指標にいなる重力加速度がZ軸＝ヨー軸を貫いているため）

  - ヨー角を補正するためには磁気センサが必要（つまり9軸センサでなければならない），だが精度は悪い

    [9軸センサで相補フィルタ使って姿勢推定](https://qiita.com/Tanba28/items/5092c3e5e2c631b804f3)

  - 逆に，6軸センサでヨー角を補正するとなると，経験則でフィルタをかける必要がある．
  - 

#### 相補フィルタ

- ジャイロにHPF，加速度にLPFをかけて，それらを組み合わせて角度をいい感じに推定する

- パラメータ変動がしないため，静的フィルタ

  [yuqlid wiki 相補フィルタ](https://yuqlid.sakura.ne.jp/dokuwiki/doku.php?id=相補フィルタ)

#### カルマンフィルタ

- 線形モデルに対応

- [6軸IMU 拡張カルマンフィルタ](https://memo.soarcloud.com/6軸imu～拡張カルマンフィルタ/)

#### 拡張カルマンフィルタ

- 非線形モデルに対応

#### DMP



## モータ制御



## 走行制御



## 探索アルゴリズム



## 経路計画 



## 走行シミュレータ





# メカ

### Fusion360



### モータマウント

